<!DOCTYPE html>
<html>
  <head>
    <title>My App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="app.min.css">
    <style>
      /* TODO */
      .section-title {
        text-align: center;
        padding: 10px 0;
      }
    </style>
  </head>

  <body>
    <div class="app-page" data-page="home">
      <div class="app-topbar blue">
        <div class="app-title">Send An Email</div>
      </div>
      <div class="app-content">
        <div class="app-section">
          <div class="alert-msg" id="home-alert">Click below to send an email!</div>
        </div>
        <div class="app-section" id="prev-recip">
          <div class="section-title"><strong>Previous Recipients</strong><br /></div>
          <div class ="previous-recipients-div">
          <div class="app-button" class="move-to-email" data-target="email-page">Send to new user</div>
          <div class="app-button" class="move-to-email" data-target="email-page">Send to new user</div>
          <div class="app-button" class="move-to-email" data-target="email-page">Send to new user</div>
          </div>
        </div>
        <div class="app-section">
          <div class="app-button" class="move-to-email" data-target="email-page">Send to new user</div>
        </div>
      </div>
    </div>

    <div class="app-page" data-page="email-page">
      <div class="app-topbar">
        <div class="app-button right" data-back>Done</div>
        <div class="app-title">Send Email</div>
      </div>

      <div class="app-content">

        <div class="app-section">
          <div class="alert-msg" id="email-alert">Click below to send an email!</div>
        </div>
        <div class="app-section">
          <label for="email-from">From:</label><input type="email" class="app-input" name="email-from" placeholder="Sender's email address">
          <label for="email-to">To:</label><input type="email" class="app-input" name="email-to" placeholder="Recipient's email address">
        </div>

        <div class="app-section">
          <input class="app-input" name="email-subject" placeholder="Subject">
          <textarea class="app-input" name="email-message" placeholder="Message"></textarea>
          <div class="app-button green send-button">Send</div>
        </div>
      </div>

    </div>

    <script src="zepto.js"></script>
    <script src="app.min.js"></script>
    <script>

    App.controller('home', function (page) {

    });

    App.controller('email-page', function (page) {

      //Send button has been clicked
      $(page).find('.send-button').on('click', function(event) {

        //Values
        var $EmailFromVal = $("input[name=email-from]")[0].value;
        var $EmailToVal = $("input[name=email-to]")[0].value;
        var $EmailSubVal = $("input[name=email-subject]")[0].value;
        var $EmailMsgVal = $("textarea[name=email-message]")[0].value;

        //From & To Validation - Hard stop if not correct
        function isEmail(email) {
          var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
          return regex.test(email);
        };

        var $EmailToFromError = "";

        if ($EmailFromVal == "") {
          $EmailToFromError += "You have not included the sender's email<br />";
        } else if (isEmail($EmailFromVal) == false) {
          $EmailToFromError += "The input for the sender's email is invalid. Please ensure it is correct.<br />";
        };

        if ($EmailToVal == "") {
          $EmailToFromError += "You have not included the recipient's email<br />";
        } else if (isEmail($EmailToVal) == false) {
          $EmailToFromError += "The input for the recipient's email is invalid. Please ensure it is correct.<br />";
        };

        if ($EmailToFromError != "") {
          $("#email-alert").html("<p>The following errors are present in your submission. You cannot send the email until these are fixed:</p><br /><p>" + $EmailToFromError + "</p>");
          event.preventDefault();
          return false;
        };

        //Sub and Msg Validation - Warning if incomplete but allow submission
        var $EmailSubMsgError = [];

        if ($EmailSubVal == "") {
          $EmailSubMsgError.push("Subject");
        };

        if ($EmailMsgVal == "") {
          $EmailSubMsgError.push("Message");
        };

        //If there is something missing
        if($EmailSubMsgError.length != 0) {
          //If only one missing, else will be both
          if ($EmailSubMsgError.length == 1) {
            confirm("You have not included a " + $EmailSubMsgError[0] + ", are you sure you want to continue?");
          } else {
            confirm("You have not included a " + $EmailSubMsgError[0] + " or " + $EmailSubMsgError[1] + ", are you sure you want to continue?");
          };
        };

      });

    });

    try {
      App.restore();
    } catch (err) {
      App.load('home');
    };




/*
Further developing script, but problems with how the localkeys save/display only
previous saved data, not from current session. once figured out to use function
to create recipients list on home page, and save sender to email page. Then use
php script (inc validation) to send emails


      var $getSender = localStorage.getItem("sender");
      var $getRecipients;

      if(localStorage.getItem("recipients") != null) {
        $getRecipients = JSON.parse(localStorage.getItem("recipients"));
      };

      console.log($getSender);
      console.log($getRecipients);

      App.controller('home', function (page) {
        // put stuff here

        function AddPrevRecip(text) {
          $(".previous-recipients-div").add(text);
        }

      });

      App.controller('email-page', function (page) {
        // put stuff here

        ////////////LOOK INTO THIS BIT - PRE-POP INPUT////////////

            if($getSender != "") {
              $("input[name=email-from]").val($getSender);
            };

            /////////////////////////////////////////////////////


        $(page).find('.send-button')
          .on('click', function () {

            //VALIDATION START

            //Declare From email value
            var $EmailFrom = $("input[name=email-from]");
            var $EmailFromVal = $EmailFrom[0].value;
            //Declare To email value
            var $EmailTo = $("[name=email-to]");
            var $EmailToVal = $EmailTo[0].value;
            //Declare Subject of email value
            var $EmailSub = $("[name=email-subject]");
            var $EmailSubVal = $EmailSub[0].value;
            //Declare Message of email value
            var $EmailMsg = $("[name=email-message]");
            var $EmailMsgVal = $EmailMsg[0].value;

            var $EmailError = "";

            //function for email validation
            function isEmail(email) {
              var regex = /^([a-zA-Z0-9_.+-])+\@(([a-zA-Z0-9-])+\.)+([a-zA-Z0-9]{2,4})+$/;
              return regex.test(email);
            }

            //From email is input, if not error, if invalid email format error
            if ($EmailFromVal == "") {
              $EmailError += "You have not included the sender's email<br />";
            } else if (isEmail($EmailFromVal) == false) {
              $EmailError += "The input for the sender's email is invalid. Please ensure it is correct.<br />";
            };

            //To email is input, if not error, if invalid email format error
            if ($EmailToVal == "") {
              $EmailError += "You have not included the recipient's email<br />";
            } else if (isEmail($EmailToVal) == false) {
              $EmailError += "The input for the recipient's email is invalid. Please ensure it is correct.<br />";
            };

            //If no subject or email, don't prevent sending but do warn the user
            var $ConfirmMissing = [];

            if ($EmailSubVal == "") {
              $ConfirmMissing.push("Subject");
            };

            if ($EmailMsgVal == "") {
              $ConfirmMissing.push("Message");
            };

            //If error, display and reset error, else show confirm message
            //if($EmailError != "") {
            //  $("#email-alert").html("<p>The following errors are present in your submission. You cannot send the email until these are fixed:</p><br /><p>" + $EmailError + "</p>");
            //  $EmailError = "";
            if ($EmailError == "") {    //If successful

              if($ConfirmMissing.length != 0) {  //If the user doesn't input a subject of message, ask to confirm

                if ($ConfirmMissing.length == 1) {
                  confirm("You have not included a " + $ConfirmMissing[0] + ", are you sure you want to continue?");
                } else {
                  confirm("You have not included a " + $ConfirmMissing[0] + " or " + $ConfirmMissing[1] + ", are you sure you want to continue?");
                }

              };
              //VALIDATION END

              if (confirm) {
                function saveLocalStorage(storeName, value) {
                  localStorage.setItem(storeName, value);
                };

                saveLocalStorage("sender", $EmailFromVal);

                //Create array of previous recipients
                var i = 0;
                var $prevRecipients = ["recip@test.com", 2 ,4, 5];
                var $prevNewAdd = true;

                do {

                  if($prevRecipients[i] == $EmailToVal) {
                    $prevNewAdd = false;
                  };

                  i++;

                } while ( i < $prevRecipients.length );

                if ($prevNewAdd == true) {
                  $prevRecipients.push($EmailToVal);
                };

                saveLocalStorage("recipients", (JSON.stringify($prevRecipients)));

                alert($getRecipients);
                alert($getSender);

                //End of creating array

                //Set if correct
                $("#email-alert").html("<p> The sender and recipient's emails are both correct</p>");

              } else {
                $("#email-alert").html("<p>The following errors are present in your submission. You cannot send the email until these are fixed:</p><br /><p>" + $EmailError + "</p>");
              };
            };
          });
      });

      try {
        App.restore();
      } catch (err) {
        App.load('home');
      }*/
    </script>
  </body>
</html>
